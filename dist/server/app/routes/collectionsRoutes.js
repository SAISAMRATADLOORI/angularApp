"use strict";
var express = require("express");
var mongodb_1 = require("mongodb");
var config = require("../config");
var router = express.Router();
exports.router = router;
var rootPath = "/";
var collectionsPath = "/collections";
var listOfRuns = "/collections/:collectionId/runs";
var listOfRunsDocs = "/collections/:collectionId";
var runInfo = "/collections/:collectionId/runs/:runId";
router.get(rootPath, function (req, res) {
    res.redirect(collectionsPath);
});
router.get(collectionsPath, function (req, res) {
    var components = [];
    var mongoClient = new mongodb_1.MongoClient();
    mongoClient.connect(config.mongoDBConnectionString).then(function (db) {
        console.log("Connected to DB successfully");
        var out = [];
        db.collections().then(function (collections) {
            collections.forEach(function (collection) {
                console.log("Collection Name - " + collection.collectionName);
                out.push(collection.collectionName);
            });
            db.close();
            res.send(out);
        });
    }).catch(function (reason) {
        res.status(500).send(reason);
    });
});
router.get(listOfRuns, function (req, res) {
    var components = [];
    var mongoClient = new mongodb_1.MongoClient();
    mongoClient.connect(config.mongoDBConnectionString).then(function (db) {
        console.log("Connected to DB successfully");
        db.collection(req.params.collectionId).distinct("runId", {}, function (err, data) {
            console.log("Data - " + data);
            if (err) {
                res.send(500, "Something wrong " + err);
            }
            db.close();
            res.json(data);
        });
    }).catch(function (reason) {
        res.status(500).send(reason);
    });
});
router.get(listOfRunsDocs, function (req, res) {
    var components = [];
    var mongoClient = new mongodb_1.MongoClient();
    mongoClient.connect(config.mongoDBConnectionString).then(function (db) {
        console.log("Connected to DB successfully");
        db.collection(req.params.collectionId).find(req.query).toArray(function (err, data) {
            data.forEach(function (row) {
                console.log("URI - " + row.uri);
            });
            if (err) {
                res.send(500, "Something wrong " + err);
            }
            db.close();
            res.json(data);
        });
    }).catch(function (reason) {
        res.status(500).send(reason);
    });
});
router.get(runInfo, function (req, res) {
    var components = [];
    var mongoClient = new mongodb_1.MongoClient();
    mongoClient.connect(config.mongoDBConnectionString).then(function (db) {
        console.log("Connected to DB successfully");
        db.collection(req.params.collectionId).find({ "runId": Number(req.params.runId) }).toArray(function (err, data) {
            var runIdInfo = {};
            var status = "passed";
            var percentage = 0;
            var totalCount = 0;
            var passCount = 0;
            console.log(data);
            data.forEach(function (row) {
                ++totalCount;
                runIdInfo['environment'] = row.environment;
                runIdInfo['browser'] = row.browser;
                runIdInfo['time'] = new Date(Number(req.params.runId));
                runIdInfo['category'] = row.category;
                console.log("Row status - " + row.status);
                if (row.status !== "passed") {
                    status = "failed";
                }
                else {
                    ++passCount;
                }
                console.log("URI - " + runIdInfo);
            });
            percentage = passCount / totalCount * 100;
            runIdInfo['percentage'] = percentage.toString();
            runIdInfo['status'] = status;
            runIdInfo['data'] = data;
            if (err) {
                res.send(500, "Something wrong " + err);
            }
            db.close();
            res.json(runIdInfo);
        });
    }).catch(function (reason) {
        res.status(500).send(reason);
    });
});

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2FwcC9yb3V0ZXMvY29sbGVjdGlvbnNSb3V0ZXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUVBLGlDQUFvQztBQUNwQyxtQ0FBb0Q7QUFDcEQsa0NBQXNDO0FBRXRDLElBQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQTtBQTRJdEIsd0JBQU07QUExSWYsSUFBTSxRQUFRLEdBQUcsR0FBRyxDQUFDO0FBQ3JCLElBQU0sZUFBZSxHQUFHLGNBQWMsQ0FBQztBQUN2QyxJQUFNLFVBQVUsR0FBRyxpQ0FBaUMsQ0FBQztBQUNyRCxJQUFNLGNBQWMsR0FBRyw0QkFBNEIsQ0FBQztBQUNwRCxJQUFNLE9BQU8sR0FBRyx3Q0FBd0MsQ0FBQztBQUV6RCxNQUFNLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBQyxVQUFTLEdBQUcsRUFBQyxHQUFHO0lBQ2xDLEdBQUcsQ0FBQyxRQUFRLENBQUMsZUFBZSxDQUFDLENBQUM7QUFDaEMsQ0FBQyxDQUFDLENBQUE7QUFFRixNQUFNLENBQUMsR0FBRyxDQUFDLGVBQWUsRUFBRSxVQUFVLEdBQUcsRUFBRSxHQUFHO0lBQzFDLElBQUksVUFBVSxHQUFZLEVBQUUsQ0FBQztJQUcvQixJQUFJLFdBQVcsR0FBRyxJQUFJLHFCQUFXLEVBQUUsQ0FBQztJQUVuQyxXQUFXLENBQUMsT0FBTyxDQUNsQixNQUFNLENBQUMsdUJBQXVCLENBQy9CLENBQUMsSUFBSSxDQUFDLFVBQUUsRUFBRTtRQUNQLE9BQU8sQ0FBQyxHQUFHLENBQUMsOEJBQThCLENBQUMsQ0FBQztRQUM1QyxJQUFJLEdBQUcsR0FBWSxFQUFFLENBQUM7UUFDdEIsRUFBRSxDQUFDLFdBQVcsRUFBRSxDQUFDLElBQUksQ0FBQyxVQUFDLFdBQVc7WUFDcEIsV0FBVyxDQUFDLE9BQU8sQ0FBQyxVQUFDLFVBQVU7Z0JBQy9CLE9BQU8sQ0FBQyxHQUFHLENBQUMsdUJBQXFCLFVBQVUsQ0FBQyxjQUFnQixDQUFDLENBQUM7Z0JBQzlELEdBQUcs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LENBQUE7QUFDSixDQUFDLENBQUMsQ0FBQyIsImZpbGUiOiJhcHAvcm91dGVzL2NvbGxlY3Rpb25zUm91dGVzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiXG5cbmltcG9ydCAgKiBhcyBleHByZXNzIGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHsgTW9uZ29DbGllbnQsRGIsIENvbGxlY3Rpb259IGZyb20gJ21vbmdvZGInO1xuaW1wb3J0ICAqIGFzIGNvbmZpZyAgZnJvbSAnLi4vY29uZmlnJztcblxuY29uc3Qgcm91dGVyID0gZXhwcmVzcy5Sb3V0ZXIoKVxuXG5jb25zdCByb290UGF0aCA9IFwiL1wiO1xuY29uc3QgY29sbGVjdGlvbnNQYXRoID0gXCIvY29sbGVjdGlvbnNcIjtcbmNvbnN0IGxpc3RPZlJ1bnMgPSBcIi9jb2xsZWN0aW9ucy86Y29sbGVjdGlvbklkL3J1bnNcIjtcbmNvbnN0IGxpc3RPZlJ1bnNEb2NzID0gXCIvY29sbGVjdGlvbnMvOmNvbGxlY3Rpb25JZFwiO1xuY29uc3QgcnVuSW5mbyA9IFwiL2NvbGxlY3Rpb25zLzpjb2xsZWN0aW9uSWQvcnVucy86cnVuSWRcIjtcblxucm91dGVyLmdldChyb290UGF0aCxmdW5jdGlvbihyZXEscmVzKXtcbiAgcmVzLnJlZGlyZWN0KGNvbGxlY3Rpb25zUGF0aCk7XG59KVxuXG5yb3V0ZXIuZ2V0KGNvbGxlY3Rpb25zUGF0aCwgZnVuY3Rpb24gKHJlcSwgcmVzKSB7XG4gICAgbGV0IGNvbXBvbmVudHM6IFN0cmluZ1tdID1bXTtcblxuXG4gIGxldCBtb25nb0NsaWVudCA9IG5ldyBNb25nb0NsaWVudCgpO1xuXG4gICBtb25nb0NsaWVudC5jb25uZWN0KFxuICAgIGNvbmZpZy5tb25nb0RCQ29ubmVjdGlvblN0cmluZ1xuICApLnRoZW4oKCBkYiApID0+e1xuICAgICAgY29uc29sZS5sb2coYENvbm5lY3RlZCB0byBEQiBzdWNjZXNzZnVsbHlgKTtcbiAgICAgIGxldCBvdXQ6IFN0cmluZ1tdID1bXTtcbiAgICAgIGRiLmNvbGxlY3Rpb25zKCkudGhlbigoY29sbGVjdGlvbnMpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29sbGVjdGlvbnMuZm9yRWFjaCgoY29sbGVjdGlvbikgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgQ29sbGVjdGlvbiBOYW1lIC0gJHtjb2xsZWN0aW9uLmNvbGxlY3Rpb25OYW1lfWApO1xuICAgICAgICAgICAgICAgICAgICBvdXQucHVzaChjb2xsZWN0aW9uLmNvbGxlY3Rpb25OYW1lKTtcbiAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgZGIuY2xvc2UoKTtcbiAgICAgICAgICAgICAgICAgIHJlcy5zZW5kKG91dCkgXG4gICAgICAgICAgICB9KSAgICBcblxuICB9KS5jYXRjaCgocmVhc29uKSA9PiB7XG4gICAgcmVzLnN0YXR1cyg1MDApLnNlbmQocmVhc29uKTtcbiAgfSkgXG59KTtcblxuXG5yb3V0ZXIuZ2V0KGxpc3RPZlJ1bnMsIGZ1bmN0aW9uIChyZXEsIHJlcykge1xuICAgIGxldCBjb21wb25lbnRzOiBTdHJpbmdbXSA9W107XG5cblxuICBsZXQgbW9uZ29DbGllbnQgPSBuZXcgTW9uZ29DbGllbnQoKTtcblxuICAgbW9uZ29DbGllbnQuY29ubmVjdChcbiAgICBjb25maWcubW9uZ29EQkNvbm5lY3Rpb25TdHJpbmdcbiAgKS50aGVuKCggZGIgKSA9PntcbiAgICAgIGNvbnNvbGUubG9nKGBDb25uZWN0ZWQgdG8gREIgc3VjY2Vzc2Z1bGx5YCk7XG4gICAgICBkYi5jb2xsZWN0aW9uKHJlcS5wYXJhbXMuY29sbGVjdGlvbklkKS5kaXN0aW5jdChcInJ1bklkXCIse30sKGVycixkYXRhKSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIkRhdGEgLSBcIitkYXRhKTtcbiAgICAgICAgICAgIGlmKGVycil7XG4gICAgICAgICAgICAgICAgICAgIHJlcy5zZW5kKDUwMCxgU29tZXRoaW5nIHdyb25nICR7ZXJyfWApXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgZGIuY2xvc2UoKTtcbiAgICAgICAgICAgIHJlcy5qc29uKGRhdGEpO1xuICAgICAgICB9KSAgICBcblxuICB9KS5jYXRjaCgocmVhc29uKSA9PiB7XG4gICAgcmVzLnN0YXR1cyg1MDApLnNlbmQocmVhc29uKTtcbiAgfSkgXG59KTtcblxuXG5yb3V0ZXIuZ2V0KGxpc3RPZlJ1bnNEb2NzLCBmdW5jdGlvbiAocmVxLCByZXMpIHtcbiAgICBsZXQgY29tcG9uZW50czogU3RyaW5nW10gPVtdO1xuXG5cbiAgbGV0IG1vbmdvQ2xpZW50ID0gbmV3IE1vbmdvQ2xpZW50KCk7XG5cbiAgIG1vbmdvQ2xpZW50LmNvbm5lY3QoXG4gICAgY29uZmlnLm1vbmdvREJDb25uZWN0aW9uU3RyaW5nXG4gICkudGhlbigoIGRiICkgPT57XG4gICAgICBjb25zb2xlLmxvZyhgQ29ubmVjdGVkIHRvIERCIHN1Y2Nlc3NmdWxseWApO1xuICAgICAgZGIuY29sbGVjdGlvbihyZXEucGFyYW1zLmNvbGxlY3Rpb25JZCkuZmluZChyZXEucXVlcnkpLnRvQXJyYXkoKGVycixkYXRhKSA9PiB7XG4gICAgICAgICAgICAgICAgZGF0YS5mb3JFYWNoKChyb3cpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFVSSSAtIGArcm93LnVyaSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgaWYoZXJyKXtcbiAgICAgICAgICAgICAgICAgICAgcmVzLnNlbmQoNTAwLGBTb21ldGhpbmcgd3JvbmcgJHtlcnJ9YClcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZGIuY2xvc2UoKTtcbiAgICAgICAgICAgICAgICByZXMuanNvbihkYXRhKTsgICAgICAgICBcbiAgICB9KSAgXG5cbiAgfSkuY2F0Y2goKHJlYXNvbikgPT4ge1xuICAgIHJlcy5zdGF0dXMoNTAwKS5zZW5kKHJlYXNvbik7XG4gIH0pIFxufSk7XG5cbnJvdXRlci5nZXQocnVuSW5mbywgZnVuY3Rpb24gKHJlcSwgcmVzKSB7XG4gICAgbGV0IGNvbXBvbmVudHM6IFN0cmluZ1tdID1bXTtcblxuXG4gIGxldCBtb25nb0NsaWVudCA9IG5ldyBNb25nb0NsaWVudCgpO1xuXG4gICBtb25nb0NsaWVudC5jb25uZWN0KFxuICAgIGNvbmZpZy5tb25nb0RCQ29ubmVjdGlvblN0cmluZ1xuICApLnRoZW4oKCBkYiApID0+e1xuICAgICAgY29uc29sZS5sb2coYENvbm5lY3RlZCB0byBEQiBzdWNjZXNzZnVsbHlgKTtcbiAgICAgIFxuICAgICAgZGIuY29sbGVjdGlvbihyZXEucGFyYW1zLmNvbGxlY3Rpb25JZCkuZmluZCh7XCJydW5JZFwiOiBOdW1iZXIocmVxLnBhcmFtcy5ydW5JZCl9KS50b0FycmF5KChlcnIsZGF0YSkgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBydW5JZEluZm8gPSB7fTtcbiAgICAgICAgICAgICAgICBsZXQgc3RhdHVzID0gXCJwYXNzZWRcIjtcbiAgICAgICAgICAgICAgICBsZXQgcGVyY2VudGFnZSA9IDA7XG4gICAgICAgICAgICAgICAgbGV0IHRvdGFsQ291bnQgPSAwO1xuICAgICAgICAgICAgICAgIGxldCBwYXNzQ291bnQ9MDtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhkYXRhKTtcbiAgICAgICAgICAgICAgICBkYXRhLmZvckVhY2goKHJvdykgPT4ge1xuICAgICAgICAgICAgICAgICAgKyt0b3RhbENvdW50O1xuICAgICAgICAgICAgICAgICAgcnVuSWRJbmZvWydlbnZpcm9ubWVudCddPXJvdy5lbnZpcm9ubWVudDtcbiAgICAgICAgICAgICAgICAgIHJ1bklkSW5mb1snYnJvd3NlciddID0gcm93LmJyb3dzZXI7XG4gICAgICAgICAgICAgICAgICBydW5JZEluZm9bJ3RpbWUnXT0gbmV3IERhdGUoTnVtYmVyKHJlcS5wYXJhbXMucnVuSWQpKTtcbiAgICAgICAgICAgICAgICAgIHJ1bklkSW5mb1snY2F0ZWdvcnknXSA9IHJvdy5jYXRlZ29yeTtcbiAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiUm93IHN0YXR1cyAtIFwiK3Jvdy5zdGF0dXMpXG4gICAgICAgICAgICAgICAgICBpZihyb3cuc3RhdHVzICE9PSBcInBhc3NlZFwiKXtcbiAgICAgICAgICAgICAgICAgICAgICBzdGF0dXMgPSBcImZhaWxlZFwiO1xuICAgICAgICAgICAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICAgICAgICAgICsrcGFzc0NvdW50O1xuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgVVJJIC0gYCtydW5JZEluZm8pO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIHBlcmNlbnRhZ2UgPSBwYXNzQ291bnQvdG90YWxDb3VudCAqIDEwMDtcbiAgICAgICAgICAgICAgICBydW5JZEluZm9bJ3BlcmNlbnRhZ2UnXSA9IHBlcmNlbnRhZ2UudG9TdHJpbmcoKTtcbiAgICAgICAgICAgICAgICBydW5JZEluZm9bJ3N0YXR1cyddID0gc3RhdHVzO1xuICAgICAgICAgICAgICAgIHJ1bklkSW5mb1snZGF0YSddID0gZGF0YTtcbiAgICAgICAgICAgICAgICBpZihlcnIpe1xuICAgICAgICAgICAgICAgICAgICByZXMuc2VuZCg1MDAsYFNvbWV0aGluZyB3cm9uZyAke2Vycn1gKVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBkYi5jbG9zZSgpO1xuICAgICAgICAgICAgICAgIHJlcy5qc29uKHJ1bklkSW5mbyk7ICAgICAgICAgXG4gICAgfSkgIFxuXG4gIH0pLmNhdGNoKChyZWFzb24pID0+IHtcbiAgICByZXMuc3RhdHVzKDUwMCkuc2VuZChyZWFzb24pO1xuICB9KSBcbn0pO1xuXG5cblxuXG5leHBvcnQgeyByb3V0ZXIgfTsiXX0=
